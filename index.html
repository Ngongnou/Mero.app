<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rapport Technique</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root {
  --bg: #0d0f14;
  --surface: #161920;
  --surface2: #1e2230;
  --border: #2a2f3d;
  --accent: #4f9cf9;
  --accent2: #f97f4f;
  --success: #4fc97a;
  --danger: #f94f6b;
  --text: #e8eaf0;
  --muted: #6b7280;
  --r: 14px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  min-height: 100vh;
  padding-bottom: 60px;
}

/* HEADER */
header {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 16px 20px;
  position: sticky; top: 0; z-index: 100;
  display: flex; align-items: center; gap: 12px;
}
.logo {
  width: 38px; height: 38px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; flex-shrink: 0;
}
.header-text h1 {
  font-family: 'Syne', sans-serif;
  font-size: 1rem; font-weight: 800; letter-spacing: -0.3px;
}
.header-text span { font-size: 0.72rem; color: var(--muted); }

/* TABS */
.tabs {
  display: flex; background: var(--surface);
  border-bottom: 1px solid var(--border);
}
.tab {
  flex: 1; padding: 14px 10px;
  text-align: center; font-size: 0.82rem; font-weight: 600;
  color: var(--muted); cursor: pointer;
  border-bottom: 2px solid transparent; transition: all 0.2s;
}
.tab.active { color: var(--accent); border-bottom-color: var(--accent); }

/* VIEWS */
.view { display: none; padding: 16px; }
.view.active { display: block; }

/* FORM SECTIONS */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 18px; margin-bottom: 14px;
}
.card-title {
  font-family: 'Syne', sans-serif;
  font-size: 0.75rem; font-weight: 700;
  text-transform: uppercase; letter-spacing: 1px;
  color: var(--muted); margin-bottom: 14px;
  display: flex; align-items: center; gap: 8px;
}
.card-title::before {
  content: ''; width: 3px; height: 13px;
  background: var(--accent); border-radius: 2px;
}
label {
  display: block; font-size: 0.8rem;
  color: var(--muted); margin-bottom: 5px; font-weight: 500;
}
input[type="date"], input[type="text"], textarea {
  width: 100%; background: var(--bg);
  border: 1px solid var(--border); border-radius: 10px;
  color: var(--text); padding: 11px 13px;
  font-family: 'DM Sans', sans-serif; font-size: 0.9rem;
  outline: none; transition: border-color 0.2s;
  -webkit-appearance: none; appearance: none;
}
input:focus, textarea:focus { border-color: var(--accent); }
textarea { resize: vertical; min-height: 80px; }
.field { margin-bottom: 12px; }
.field:last-child { margin-bottom: 0; }
.row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

/* SALLE BLOCK */
.salle-block {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 12px;
  margin-bottom: 14px;
  overflow: hidden;
}
.salle-header {
  background: var(--surface2);
  padding: 12px 14px;
  display: flex; align-items: center; gap: 10px;
  cursor: pointer;
}
.salle-num {
  width: 26px; height: 26px;
  background: linear-gradient(135deg, var(--accent), #3a7bd5);
  border-radius: 7px;
  display: flex; align-items: center; justify-content: center;
  font-family: 'Syne', sans-serif;
  font-size: 0.72rem; font-weight: 800; color: #fff;
  flex-shrink: 0;
}
.salle-name-display {
  font-family: 'Syne', sans-serif;
  font-size: 0.88rem; font-weight: 700; flex: 1;
}
.salle-remove {
  width: 28px; height: 28px;
  background: transparent; border: 1px solid var(--border);
  border-radius: 7px; color: var(--muted);
  cursor: pointer; display: flex; align-items: center;
  justify-content: center; font-size: 16px; transition: all 0.2s;
  flex-shrink: 0;
}
.salle-remove:hover { background: var(--danger); color: #fff; border-color: var(--danger); }
.salle-body { padding: 14px; }

/* PROBLEM ITEMS */
.problems-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 8px; }
.problem-item {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 9px; padding: 10px 12px;
}
.problem-item.resolved { border-color: rgba(79,201,122,0.3); }
.problem-item.unresolved { border-color: rgba(249,79,107,0.3); }
.ph { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
.stoggle {
  display: flex; background: var(--bg);
  border-radius: 6px; overflow: hidden; flex-shrink: 0;
}
.sbtn {
  padding: 4px 9px; font-size: 0.7rem; font-weight: 700;
  cursor: pointer; border: none; background: transparent;
  color: var(--muted); transition: all 0.18s;
}
.sbtn.res.on { background: var(--success); color: #fff; }
.sbtn.unres.on { background: var(--danger); color: #fff; }
.rm {
  margin-left: auto; width: 24px; height: 24px;
  background: var(--bg); border: 1px solid var(--border);
  border-radius: 6px; color: var(--muted);
  cursor: pointer; display: flex; align-items: center;
  justify-content: center; font-size: 14px; flex-shrink: 0;
}
.rm:hover { background: var(--danger); color: #fff; border-color: var(--danger); }
.pinput {
  width: 100%; background: var(--bg);
  border: 1px solid var(--border); border-radius: 7px;
  color: var(--text); padding: 8px 10px;
  font-family: 'DM Sans', sans-serif; font-size: 0.84rem; outline: none;
}
.pinput:focus { border-color: var(--accent); }

/* BUTTONS */
.btn-add-problem {
  width: 100%; padding: 9px;
  background: transparent; border: 1px dashed var(--border);
  border-radius: 8px; color: var(--muted);
  cursor: pointer; font-size: 0.82rem;
  font-family: 'DM Sans', sans-serif; transition: all 0.2s;
}
.btn-add-problem:hover { border-color: var(--accent); color: var(--accent); }
.btn-add-salle {
  width: 100%; padding: 13px;
  background: var(--surface2); border: 1px dashed var(--border);
  border-radius: 12px; color: var(--muted);
  cursor: pointer; font-size: 0.88rem;
  font-family: 'DM Sans', sans-serif; transition: all 0.2s;
  margin-bottom: 14px;
}
.btn-add-salle:hover { border-color: var(--accent2); color: var(--accent2); }
.btn {
  padding: 13px 20px; border-radius: 12px;
  font-family: 'Syne', sans-serif; font-weight: 700;
  font-size: 0.88rem; cursor: pointer; border: none;
  transition: all 0.2s; display: inline-flex;
  align-items: center; gap: 8px;
}
.btn-primary {
  background: linear-gradient(135deg, var(--accent), #3a7bd5);
  color: #fff; width: 100%; justify-content: center;
}
.btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
.btn-danger-sm {
  background: transparent; color: var(--danger);
  border: 1px solid var(--danger); padding: 7px 14px;
  border-radius: 8px; font-size: 0.78rem;
}

/* REPORTS LIST */
.empty {
  text-align: center; padding: 60px 20px; color: var(--muted);
}
.empty .icon { font-size: 44px; margin-bottom: 14px; }
.rcard {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r); padding: 16px; margin-bottom: 12px;
  cursor: pointer; transition: all 0.2s;
}
.rcard:hover { border-color: var(--accent); }
.rcard-head { display: flex; align-items: flex-start; gap: 12px; }
.rcard-icon {
  width: 42px; height: 42px;
  background: linear-gradient(135deg, rgba(79,156,249,.15), rgba(249,127,79,.15));
  border-radius: 11px; display: flex; align-items: center;
  justify-content: center; font-size: 20px; flex-shrink: 0;
}
.rcard-info h3 {
  font-family: 'Syne', sans-serif;
  font-size: 0.92rem; font-weight: 800;
}
.rcard-info p { font-size: 0.78rem; color: var(--muted); margin-top: 3px; }
.rcard-actions {
  margin-left: auto; display: flex; gap: 6px; flex-shrink: 0;
}
.ibtn {
  width: 32px; height: 32px; border-radius: 8px;
  border: 1px solid var(--border); background: var(--surface2);
  color: var(--text); cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; transition: all 0.2s;
}
.ibtn:hover { border-color: var(--accent); color: var(--accent); }
.ibtn.del:hover { border-color: var(--danger); color: var(--danger); }
.rmeta { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
.badge {
  padding: 3px 9px; border-radius: 20px;
  font-size: 0.7rem; font-weight: 600;
}
.bg { background: rgba(79,156,249,.15); color: var(--accent); }
.bgr { background: rgba(79,201,122,.15); color: var(--success); }
.brd { background: rgba(249,79,107,.15); color: var(--danger); }
.bgy { background: rgba(249,127,79,.15); color: var(--accent2); }
.bgg { background: var(--surface2); color: var(--muted); }

/* DETAIL */
.back-btn {
  display: flex; align-items: center; gap: 6px;
  color: var(--accent); font-size: 0.85rem; font-weight: 600;
  cursor: pointer; background: none; border: none; padding: 0;
  margin-bottom: 14px;
}
.detail-hero {
  background: linear-gradient(135deg, rgba(79,156,249,.1), rgba(249,127,79,.1));
  border: 1px solid var(--border); border-radius: var(--r);
  padding: 18px; margin-bottom: 14px;
}
.detail-hero h2 {
  font-family: 'Syne', sans-serif;
  font-size: 1.2rem; font-weight: 800;
}
.detail-hero p { color: var(--muted); font-size: 0.83rem; margin-top: 5px; }
.dsection {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r); padding: 16px; margin-bottom: 12px;
}
.dsection h4 {
  font-family: 'Syne', sans-serif;
  font-size: 0.75rem; font-weight: 700;
  text-transform: uppercase; letter-spacing: 1px;
  color: var(--muted); margin-bottom: 12px;
}
.salle-detail-title {
  font-family: 'Syne', sans-serif;
  font-size: 0.88rem; font-weight: 700;
  color: var(--accent); margin-bottom: 10px;
  padding-bottom: 8px; border-bottom: 1px solid var(--border);
}
.pbadge {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 12px; border-radius: 8px; margin-bottom: 6px;
  font-size: 0.85rem;
}
.pbadge.res { background: rgba(79,201,122,.1); border: 1px solid rgba(79,201,122,.2); }
.pbadge.unres { background: rgba(249,79,107,.1); border: 1px solid rgba(249,79,107,.2); }
.dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.dot.res { background: var(--success); }
.dot.unres { background: var(--danger); }

/* TOAST */
.toast {
  position: fixed; bottom: 24px; left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: var(--success); color: #fff;
  padding: 11px 18px; border-radius: 10px;
  font-size: 0.85rem; font-weight: 600;
  z-index: 300; transition: transform 0.3s; white-space: nowrap;
}
.toast.show { transform: translateX(-50%) translateY(0); }
.toast.err { background: var(--danger); }

@media(max-width:360px) { .row2 { grid-template-columns: 1fr; } }
</style>
</head>
<body>

<header>
  <div class="logo">üîß</div>
  <div class="header-text">
    <h1>Rapport Technique</h1>
    <span id="today-label"></span>
  </div>
</header>

<div class="tabs">
  <div class="tab active" onclick="showTab('new')">‚úèÔ∏è Nouveau</div>
  <div class="tab" onclick="showTab('list')">üìã Rapports</div>
</div>

<!-- NEW / EDIT -->
<div class="view active" id="view-new">

  <div class="card">
    <div class="card-title">Informations g√©n√©rales</div>
    <div class="row2">
      <div class="field">
        <label>Date d'intervention</label>
        <input type="date" id="f-date" />
      </div>
      <div class="field">
        <label>Technicien</label>
        <input type="text" id="f-tech" placeholder="Nom" />
      </div>
    </div>
    <div class="field">
      <label>Zone d'intervention</label>
      <input type="text" id="f-zone" placeholder="Ex: B√¢timent A, Bloc Nord‚Ä¶" />
    </div>
  </div>

  <!-- SALLES -->
  <div id="salles-container"></div>

  <button class="btn-add-salle" onclick="addSalle()">üè¢ Ajouter une salle</button>

  <div class="card">
    <div class="card-title">Remarques g√©n√©rales</div>
    <div class="field">
      <textarea id="f-remarques" placeholder="Observations, recommandations, actions futures‚Ä¶"></textarea>
    </div>
  </div>

  <button class="btn btn-primary" onclick="saveReport()">üíæ Enregistrer le rapport</button>
</div>

<!-- LIST -->
<div class="view" id="view-list">
  <div id="reports-container"></div>
</div>

<!-- DETAIL -->
<div class="view" id="view-detail">
  <button class="back-btn" onclick="showTab('list')">‚Üê Retour</button>
  <div id="detail-content"></div>
  <button class="btn btn-primary" onclick="generatePDF(currentReport)" style="margin-top:12px">
    üìÑ T√©l√©charger le PDF
  </button>
</div>

<div class="toast" id="toast"></div>

<script>
let reports = JSON.parse(localStorage.getItem('rapportsTechniques') || '[]');
let currentReport = null;
let editingId = null;
let salleCounter = 0;

// Init date
const today = new Date();
document.getElementById('f-date').value = today.toISOString().split('T')[0];
document.getElementById('today-label').textContent = today.toLocaleDateString('fr-FR', {weekday:'long', day:'numeric', month:'long'});

// Start with one salle
addSalle();

/* ====== SALLE MANAGEMENT ====== */
function addSalle(name='', problems=[]) {
  salleCounter++;
  const sid = 'salle-' + Date.now() + '-' + salleCounter;
  const c = document.getElementById('salles-container');
  const div = document.createElement('div');
  div.className = 'salle-block';
  div.dataset.sid = sid;

  div.innerHTML = `
    <div class="salle-header" onclick="toggleSalle('${sid}')">
      <div class="salle-num">${salleCounter}</div>
      <div class="salle-name-display" id="sdisplay-${sid}">${name || 'Salle ' + salleCounter}</div>
      <button class="salle-remove" onclick="event.stopPropagation(); removeSalle('${sid}')" title="Supprimer">√ó</button>
    </div>
    <div class="salle-body" id="sbody-${sid}">
      <div class="field">
        <label>Nom de la salle</label>
        <input type="text" class="salle-name-input" data-sid="${sid}"
          placeholder="Ex: Salle A1, Laboratoire 3‚Ä¶"
          value="${name}"
          oninput="updateSalleName('${sid}', this.value)" />
      </div>
      <div class="problems-list" id="plist-${sid}"></div>
      <button class="btn-add-problem" onclick="addProblem('${sid}')">+ Ajouter un probl√®me</button>
    </div>
  `;
  c.appendChild(div);

  if (problems.length) {
    problems.forEach(p => addProblem(sid, p.desc, p.resolved));
  } else {
    addProblem(sid);
  }
}

function toggleSalle(sid) {
  const body = document.getElementById('sbody-' + sid);
  body.style.display = body.style.display === 'none' ? 'block' : 'none';
}

function removeSalle(sid) {
  const block = document.querySelector(`.salle-block[data-sid="${sid}"]`);
  if (block) block.remove();
  renumberSalles();
}

function renumberSalles() {
  document.querySelectorAll('.salle-block').forEach((b, i) => {
    b.querySelector('.salle-num').textContent = i + 1;
  });
}

function updateSalleName(sid, val) {
  const d = document.getElementById('sdisplay-' + sid);
  if (d) d.textContent = val || 'Salle sans nom';
}

function addProblem(sid, desc='', resolved=true) {
  const list = document.getElementById('plist-' + sid);
  if (!list) return;
  const pid = 'p-' + Date.now() + '-' + Math.random().toString(36).slice(2,6);
  const div = document.createElement('div');
  div.className = 'problem-item ' + (resolved ? 'resolved' : 'unresolved');
  div.dataset.pid = pid;
  div.innerHTML = `
    <div class="ph">
      <div class="stoggle">
        <button class="sbtn res ${resolved ? 'on' : ''}" onclick="toggleP(this, true, '${pid}')">‚úì R√©solu</button>
        <button class="sbtn unres ${!resolved ? 'on' : ''}" onclick="toggleP(this, false, '${pid}')">‚úó Non r√©solu</button>
      </div>
      <button class="rm" onclick="this.closest('.problem-item').remove()">√ó</button>
    </div>
    <input class="pinput" type="text" placeholder="D√©crire le probl√®me‚Ä¶" value="${desc.replace(/"/g,'&quot;')}">
  `;
  list.appendChild(div);
}

function toggleP(btn, isRes, pid) {
  const item = btn.closest('.problem-item');
  item.querySelectorAll('.sbtn').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
  item.className = 'problem-item ' + (isRes ? 'resolved' : 'unresolved');
}

/* ====== DATA COLLECTION ====== */
function getSalles() {
  const salles = [];
  document.querySelectorAll('.salle-block').forEach(block => {
    const sid = block.dataset.sid;
    const nameInput = block.querySelector('.salle-name-input');
    const name = nameInput ? nameInput.value.trim() : '';
    const problems = [];
    block.querySelectorAll('.problem-item').forEach(item => {
      const desc = item.querySelector('.pinput').value.trim();
      const resolved = item.classList.contains('resolved');
      if (desc) problems.push({ desc, resolved });
    });
    salles.push({ sid, name: name || 'Salle sans nom', problems });
  });
  return salles;
}

/* ====== SAVE ====== */
function saveReport() {
  const date = document.getElementById('f-date').value;
  const zone = document.getElementById('f-zone').value.trim();
  if (!date || !zone) { showToast('Zone et date obligatoires', true); return; }

  const salles = getSalles();
  if (!salles.length) { showToast('Ajoutez au moins une salle', true); return; }

  const report = {
    id: editingId || Date.now(),
    date, zone,
    technicien: document.getElementById('f-tech').value.trim(),
    salles,
    remarques: document.getElementById('f-remarques').value.trim(),
    createdAt: editingId ? (reports.find(r=>r.id===editingId)?.createdAt || Date.now()) : Date.now()
  };

  if (editingId) {
    reports = reports.map(r => r.id === editingId ? report : r);
  } else {
    reports.unshift(report);
  }
  localStorage.setItem('rapportsTechniques', JSON.stringify(reports));
  showToast(editingId ? 'Rapport mis √† jour !' : 'Rapport enregistr√© !');
  editingId = null;
  clearForm();
  showTab('list');
}

function clearForm() {
  document.getElementById('f-date').value = new Date().toISOString().split('T')[0];
  document.getElementById('f-zone').value = '';
  document.getElementById('f-tech').value = '';
  document.getElementById('f-remarques').value = '';
  document.getElementById('salles-container').innerHTML = '';
  salleCounter = 0;
  addSalle();
  editingId = null;
}

/* ====== TABS ====== */
function showTab(tab) {
  document.querySelectorAll('.tab').forEach((t,i) => t.classList.toggle('active', ['new','list','detail'][i] === tab));
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById('view-'+tab).classList.add('active');
  if (tab === 'list') renderList();
  if (tab === 'new' && !editingId) clearForm();
}

/* ====== LIST ====== */
function renderList() {
  const c = document.getElementById('reports-container');
  if (!reports.length) {
    c.innerHTML = `<div class="empty"><div class="icon">üì≠</div><p>Aucun rapport.<br>Cr√©ez votre premier rapport technique.</p></div>`;
    return;
  }
  c.innerHTML = reports.map(r => {
    const totalRes = r.salles.reduce((a,s) => a + s.problems.filter(p=>p.resolved).length, 0);
    const totalUnres = r.salles.reduce((a,s) => a + s.problems.filter(p=>!p.resolved).length, 0);
    const d = new Date(r.date+'T12:00:00').toLocaleDateString('fr-FR', {day:'2-digit',month:'short',year:'numeric'});
    return `
    <div class="rcard" onclick="viewReport(${r.id})">
      <div class="rcard-head">
        <div class="rcard-icon">üè¢</div>
        <div class="rcard-info">
          <h3>${r.zone}</h3>
          <p>${d}${r.technicien ? ' ¬∑ ' + r.technicien : ''}</p>
        </div>
        <div class="rcard-actions" onclick="event.stopPropagation()">
          <button class="ibtn" title="PDF" onclick="generatePDF(reports.find(r=>r.id===${r.id}))">üìÑ</button>
          <button class="ibtn" title="Modifier" onclick="editReport(${r.id})">‚úèÔ∏è</button>
          <button class="ibtn del" title="Supprimer" onclick="deleteReport(${r.id})">üóë</button>
        </div>
      </div>
      <div class="rmeta">
        <span class="badge bgy">üè¢ ${r.salles.length} salle${r.salles.length>1?'s':''}</span>
        ${totalRes ? `<span class="badge bgr">‚úì ${totalRes} r√©solu${totalRes>1?'s':''}</span>` : ''}
        ${totalUnres ? `<span class="badge brd">‚úó ${totalUnres} non r√©solu${totalUnres>1?'s':''}</span>` : ''}
      </div>
    </div>`;
  }).join('');
}

/* ====== DETAIL ====== */
function viewReport(id) {
  currentReport = reports.find(r => r.id === id);
  if (!currentReport) return;
  const d = new Date(currentReport.date+'T12:00:00').toLocaleDateString('fr-FR', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
  const totalRes = currentReport.salles.reduce((a,s) => a + s.problems.filter(p=>p.resolved).length, 0);
  const totalUnres = currentReport.salles.reduce((a,s) => a + s.problems.filter(p=>!p.resolved).length, 0);

  document.getElementById('detail-content').innerHTML = `
    <div class="detail-hero">
      <h2>${currentReport.zone}</h2>
      <p>${d}${currentReport.technicien ? ' ¬∑ ' + currentReport.technicien : ''}</p>
      <div class="rmeta" style="margin-top:10px">
        <span class="badge bgy">üè¢ ${currentReport.salles.length} salle${currentReport.salles.length>1?'s':''}</span>
        ${totalRes ? `<span class="badge bgr">‚úì ${totalRes} r√©solu${totalRes>1?'s':''}</span>` : ''}
        ${totalUnres ? `<span class="badge brd">‚úó ${totalUnres} non r√©solu${totalUnres>1?'s':''}</span>` : ''}
      </div>
    </div>
    ${currentReport.salles.map(s => `
    <div class="dsection">
      <div class="salle-detail-title">üè¢ ${s.name}</div>
      ${s.problems.filter(p=>p.resolved).map(p=>`<div class="pbadge res"><div class="dot res"></div>${p.desc}</div>`).join('')}
      ${s.problems.filter(p=>!p.resolved).map(p=>`<div class="pbadge unres"><div class="dot unres"></div>${p.desc}</div>`).join('')}
      ${!s.problems.length ? `<p style="color:var(--muted);font-size:.83rem">Aucun probl√®me enregistr√©.</p>` : ''}
    </div>`).join('')}
    ${currentReport.remarques ? `
    <div class="dsection">
      <h4>üìù Remarques g√©n√©rales</h4>
      <p style="font-size:.88rem;line-height:1.65">${currentReport.remarques}</p>
    </div>` : ''}
  `;
  showTab('detail');
}

/* ====== EDIT ====== */
function editReport(id) {
  const r = reports.find(x => x.id === id);
  if (!r) return;
  editingId = id;
  document.getElementById('f-date').value = r.date;
  document.getElementById('f-zone').value = r.zone;
  document.getElementById('f-tech').value = r.technicien || '';
  document.getElementById('f-remarques').value = r.remarques || '';
  document.getElementById('salles-container').innerHTML = '';
  salleCounter = 0;
  r.salles.forEach(s => addSalle(s.name, s.problems));
  showTab('new');
}

function deleteReport(id) {
  if (!confirm('Supprimer ce rapport ?')) return;
  reports = reports.filter(r => r.id !== id);
  localStorage.setItem('rapportsTechniques', JSON.stringify(reports));
  renderList();
  showToast('Rapport supprim√©');
}

/* ====== PDF GENERATION ====== */
function generatePDF(r) {
  if (!r) return;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
  const W = 210, M = 18;
  let y = 0;
  const maxY = 270; // safe bottom margin

  function checkPage(needed) {
    if (y + needed > maxY) {
      doc.addPage();
      drawPageFooter();
      y = 18;
    }
  }

  function drawPageFooter() {
    doc.setFillColor(13,15,20);
    doc.rect(0, 287, W, 10, 'F');
    doc.setFontSize(7);
    doc.setTextColor(60,65,80);
    const pg = doc.internal.getCurrentPageInfo().pageNumber;
    doc.text(`G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')} ‚Äî Page ${pg}`, M, 294);
    doc.text('RAPPORT TECHNIQUE ‚Äî Confidentiel', W/2, 294, {align:'center'});
    doc.text(r.zone, W - M, 294, {align:'right'});
  }

  // ‚îÄ‚îÄ COVER HEADER ‚îÄ‚îÄ
  doc.setFillColor(13,15,20);
  doc.rect(0, 0, W, 48, 'F');
  doc.setFillColor(79,156,249);
  doc.rect(0, 0, 5, 48, 'F');
  // accent stripe right
  doc.setFillColor(249,127,79);
  doc.rect(W-5, 0, 5, 48, 'F');

  doc.setTextColor(232,234,240);
  doc.setFontSize(22);
  doc.setFont('helvetica', 'bold');
  doc.text('RAPPORT TECHNIQUE', 14, 20);

  doc.setFontSize(9);
  doc.setFont('helvetica', 'normal');
  doc.setTextColor(107,114,128);
  const dateStr = new Date(r.date+'T12:00:00').toLocaleDateString('fr-FR', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
  doc.text(dateStr.toUpperCase(), 14, 29);
  if (r.technicien) doc.text(`Technicien : ${r.technicien}`, 14, 36);

  doc.setTextColor(79,156,249);
  doc.setFontSize(8);
  doc.text(`REF #${r.id.toString().slice(-6)}`, W - 14, 29, {align:'right'});

  y = 58;

  // ‚îÄ‚îÄ ZONE + STATS BOX ‚îÄ‚îÄ
  doc.setFillColor(22,25,32);
  doc.roundedRect(M, y, W-2*M, 26, 3, 3, 'F');
  doc.setDrawColor(42,47,61);
  doc.roundedRect(M, y, W-2*M, 26, 3, 3, 'S');

  doc.setFontSize(7); doc.setTextColor(107,114,128);
  doc.text('ZONE', M+6, y+8);
  doc.setFontSize(13); doc.setFont('helvetica','bold'); doc.setTextColor(232,234,240);
  doc.text(r.zone, M+6, y+19);

  const totalSalles = r.salles.length;
  const totalRes = r.salles.reduce((a,s)=>a+s.problems.filter(p=>p.resolved).length,0);
  const totalUnres = r.salles.reduce((a,s)=>a+s.problems.filter(p=>!p.resolved).length,0);

  // stats right side
  doc.setFontSize(7); doc.setFont('helvetica','normal'); doc.setTextColor(107,114,128);
  doc.text('SALLES', W-M-58, y+8);
  doc.setFontSize(11); doc.setFont('helvetica','bold'); doc.setTextColor(249,127,79);
  doc.text(String(totalSalles), W-M-58, y+19);

  doc.setFontSize(7); doc.setFont('helvetica','normal'); doc.setTextColor(107,114,128);
  doc.text('R√âSOLUS', W-M-38, y+8);
  doc.setFontSize(11); doc.setFont('helvetica','bold'); doc.setTextColor(79,201,122);
  doc.text(String(totalRes), W-M-38, y+19);

  doc.setFontSize(7); doc.setFont('helvetica','normal'); doc.setTextColor(107,114,128);
  doc.text('NON R√âSOLUS', W-M-18, y+8);
  doc.setFontSize(11); doc.setFont('helvetica','bold'); doc.setTextColor(249,79,107);
  doc.text(String(totalUnres), W-M-12, y+19);

  y += 36;

  // ‚îÄ‚îÄ EACH SALLE ‚îÄ‚îÄ
  r.salles.forEach((salle, si) => {
    checkPage(28);

    // salle header bar
    doc.setFillColor(30,34,48);
    doc.roundedRect(M, y, W-2*M, 14, 3, 3, 'F');
    doc.setFillColor(79,156,249);
    doc.rect(M, y, 3, 14, 'F');
    // circle number
    doc.setFillColor(79,156,249);
    doc.circle(M+12, y+7, 5, 'F');
    doc.setFontSize(7); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
    doc.text(String(si+1), M+12, y+9, {align:'center'});

    doc.setFontSize(10); doc.setFont('helvetica','bold'); doc.setTextColor(232,234,240);
    doc.text(salle.name, M+20, y+9);

    const sr = salle.problems.filter(p=>p.resolved).length;
    const su = salle.problems.filter(p=>!p.resolved).length;
    doc.setFontSize(7); doc.setFont('helvetica','normal');
    doc.setTextColor(79,201,122);
    doc.text(`‚úì ${sr}`, W-M-28, y+9);
    doc.setTextColor(249,79,107);
    doc.text(`‚úó ${su}`, W-M-12, y+9);

    y += 18;

    if (!salle.problems.length) {
      checkPage(12);
      doc.setFontSize(8); doc.setFont('helvetica','italic'); doc.setTextColor(107,114,128);
      doc.text('Aucun probl√®me enregistr√©.', M+4, y+6);
      y += 12;
      return;
    }

    // resolved problems
    const resolved = salle.problems.filter(p=>p.resolved);
    if (resolved.length) {
      checkPage(10);
      doc.setFontSize(7.5); doc.setFont('helvetica','bold'); doc.setTextColor(79,201,122);
      doc.text('PROBL√àMES R√âSOLUS', M+4, y+5);
      y += 9;
      resolved.forEach(p => {
        const lines = doc.splitTextToSize(p.desc, W-2*M-18);
        const bh = lines.length * 5 + 8;
        checkPage(bh + 4);
        doc.setFillColor(20,50,30);
        doc.roundedRect(M, y, W-2*M, bh, 2, 2, 'F');
        doc.setTextColor(79,201,122); doc.setFontSize(9); doc.setFont('helvetica','bold');
        doc.text('‚úì', M+4, y + bh/2 + 1.5);
        doc.setTextColor(180,230,200); doc.setFontSize(8); doc.setFont('helvetica','normal');
        doc.text(lines, M+11, y + 6);
        y += bh + 4;
      });
      y += 3;
    }

    // unresolved problems
    const unresolved = salle.problems.filter(p=>!p.resolved);
    if (unresolved.length) {
      checkPage(10);
      doc.setFontSize(7.5); doc.setFont('helvetica','bold'); doc.setTextColor(249,79,107);
      doc.text('PROBL√àMES NON R√âSOLUS', M+4, y+5);
      y += 9;
      unresolved.forEach(p => {
        const lines = doc.splitTextToSize(p.desc, W-2*M-18);
        const bh = lines.length * 5 + 8;
        checkPage(bh + 4);
        doc.setFillColor(60,20,25);
        doc.roundedRect(M, y, W-2*M, bh, 2, 2, 'F');
        doc.setTextColor(249,79,107); doc.setFontSize(9); doc.setFont('helvetica','bold');
        doc.text('‚úó', M+4, y + bh/2 + 1.5);
        doc.setTextColor(230,180,185); doc.setFontSize(8); doc.setFont('helvetica','normal');
        doc.text(lines, M+11, y + 6);
        y += bh + 4;
      });
    }

    y += 6;
  });

  // ‚îÄ‚îÄ REMARQUES ‚îÄ‚îÄ
  if (r.remarques) {
    checkPage(24);
    doc.setFillColor(30,34,48);
    doc.rect(M, y, 3, 8, 'F');
    doc.setFontSize(9); doc.setFont('helvetica','bold'); doc.setTextColor(249,127,79);
    doc.text('REMARQUES G√âN√âRALES', M+6, y+6);
    y += 13;

    const lines = doc.splitTextToSize(r.remarques, W-2*M-12);
    const bh = lines.length * 5 + 14;
    checkPage(bh);
    doc.setFillColor(22,25,32);
    doc.roundedRect(M, y, W-2*M, bh, 3, 3, 'F');
    doc.setDrawColor(42,47,61);
    doc.roundedRect(M, y, W-2*M, bh, 3, 3, 'S');
    doc.setFontSize(8.5); doc.setFont('helvetica','normal'); doc.setTextColor(200,205,220);
    doc.text(lines, M+6, y+9);
    y += bh + 8;
  }

  // ‚îÄ‚îÄ SIGNATURE LINE ‚îÄ‚îÄ
  checkPage(30);
  y += 6;
  doc.setDrawColor(42,47,61);
  doc.line(M, y, M+60, y);
  doc.setFontSize(7); doc.setTextColor(107,114,128);
  doc.text('Signature du technicien', M, y+5);
  if (r.technicien) doc.text(r.technicien, M, y+11);

  drawPageFooter();

  const fname = `rapport_technique_${r.zone.replace(/\s+/g,'_')}_${r.date}.pdf`;
  doc.save(fname);
  showToast('PDF t√©l√©charg√© !');
}

/* ====== TOAST ====== */
function showToast(msg, isErr=false) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast' + (isErr ? ' err' : '');
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}
</script>
</body>
</html>
